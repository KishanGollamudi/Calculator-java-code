name: Java CI/CD Pipeline

on:
  push:
    branches: [ "master" ]

jobs:

  # ------------------------------------------------------------
  # ðŸ§ª BUILD STAGE
  # ------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build Maven Project
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ðŸ”¨ Build Project (mvn package)
        run: mvn -B clean package -DskipTests

      - name: ðŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar


  # ------------------------------------------------------------
  # ðŸ”Ž SONAR ANALYSIS STAGE
  # ------------------------------------------------------------
  sonar:
    name: ðŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: ðŸ” SonarQube Scan
        run: |
          mvn -B verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=calculator \
            -Dsonar.projectName=CalculatorApp \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}


  # ------------------------------------------------------------
  # ðŸ“¤ NEXUS UPLOAD STAGE (RAW REPO)
  # ------------------------------------------------------------
  nexus:
    name: ðŸ“¤ Upload Artifact to Nexus RAW Repo
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar

      - name: ðŸ“¡ Upload to Nexus RAW Repository
        run: |
          FILE=$(ls *.jar)
          echo "Uploading: $FILE"

          curl -v -u "${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }}" \
            --upload-file "$FILE" \
            "${{ secrets.NEXUS_HOST }}/repository/java-raw/$FILE"


  # ------------------------------------------------------------
  # ðŸ³ DOCKER BUILD + PUSH
  # ------------------------------------------------------------
  docker:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: nexus

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”½ Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: target/

      - name: ðŸ” Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: ðŸ› ï¸ Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USER }}/calculator:latest .

      - name: â˜ï¸ Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_USER }}/calculator:latest


  # ------------------------------------------------------------
  # ðŸš€ DEPLOYMENT ON EC2
  # ------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy on EC2 Server
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - name: ðŸ”‘ Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: ðŸš€ Deploy Container on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          echo "ðŸ›‘ Stopping old container..."
          sudo docker stop calculator || true
          sudo docker rm calculator || true

          echo "ðŸ³ Pulling latest image..."
          sudo docker pull ${{ secrets.DOCKER_USER }}/calculator:latest

          echo "ðŸš€ Running new container..."
          sudo docker run -d --name calculator -p 8085:8085 ${{ secrets.DOCKER_USER }}/calculator:latest

          echo "ðŸŽ‰ Deployment Complete!"
          EOF
