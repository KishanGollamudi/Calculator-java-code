name: ðŸš€ Java CI/CD Pipeline (Linear Flow)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ------------------------------------------------------------
  # 1) Build (Maven)
  # ------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build (Maven)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ðŸ”¨ Build project (package)
        run: mvn -B clean package -DskipTests=true

      - name: ðŸ“¦ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar

  # ------------------------------------------------------------
  # 2) Sonar (runs after build)
  # ------------------------------------------------------------
  sonar:
    name: ðŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ðŸ”Ž Sonar scan (Maven plugin)
        run: |
          mvn -B verify sonar:sonar \
            -DskipTests=true \
            -Dsonar.projectKey=calculator \
            -Dsonar.projectName=CalculatorApp \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  # ------------------------------------------------------------
  # 3) Nexus upload (runs AFTER sonar)
  # ------------------------------------------------------------
  nexus_upload:
    name: ðŸ“¤ Upload to Nexus (RAW)
    runs-on: ubuntu-latest
    needs: sonar

    steps:
      - name: ðŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: target/

      - name: ðŸ“¡ Upload to Nexus RAW repo
        run: |
          FILE=$(ls target/*.jar)
          BASENAME=$(basename "$FILE")
          echo "Uploading $BASENAME to Nexus RAW repository..."
          curl -v -u "${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }}" \
            --upload-file "$FILE" \
            "${{ secrets.NEXUS_HOST }}/repository/java-raw/$BASENAME"

  # ------------------------------------------------------------
  # 4) Docker build & push (runs AFTER nexus_upload)
  # ------------------------------------------------------------
  docker_push:
    name: ðŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: nexus_upload

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”½ Download artifact for Docker context (optional)
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: target/

      - name: ðŸ” DockerHub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: ðŸ› ï¸ Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USER }}/calculator:latest .

      - name: ðŸ“¤ Push Docker image
        run: docker push ${{ secrets.DOCKER_USER }}/calculator:latest

  # ------------------------------------------------------------
  # 5) Deploy to EC2 (runs AFTER docker_push)
  # ------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy to EC2 via SSH
    runs-on: ubuntu-latest
    needs: docker_push

    steps:
      - name: ðŸ” Save SSH key
        run: |
          printf "%s" "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: ðŸš€ SSH & deploy container on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "Connected: $(hostname) - deploying calculator"

            # Stop previous container (if any)
            sudo docker stop calculator || true
            sudo docker rm calculator || true

            # Pull new image and run (Tomcat-style port 8080)
            sudo docker pull ${{ secrets.DOCKER_USER }}/calculator:latest
            sudo
