name: Java CI/CD Pipeline

on:
  push:
    branches: [ "master" ]

jobs:

  # ----------------------------------------
  # ðŸ§± 1) Build with Maven
  # ----------------------------------------
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ”¨ Build Project
        run: mvn -B package --file pom.xml

      - name: ðŸ“¦ Upload Artifact (JAR)
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar

  # ----------------------------------------
  # ðŸ” 2) SonarQube Scan (Maven Plugin)
  # ----------------------------------------
  sonar:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ” SonarQube Scan
        run: |
          mvn clean verify sonar:sonar \
          -Dsonar.projectKey=calculator \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.java.binaries=target

  # ----------------------------------------
  # ðŸ—ƒï¸ 3) Upload JAR to Nexus RAW
  # ----------------------------------------
  nexus_upload:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: target/

      - name: ðŸš€ Upload JAR to Nexus RAW Repo
        run: |
          FILE=$(ls target/*.jar)
          BASENAME=$(basename $FILE)
          echo "Uploading $BASENAME to Nexus RAW..."

          curl -v -u ${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }} \
            --upload-file "$FILE" \
            "http://54.234.17.60:8081/repository/java-raw/$BASENAME"

  # ----------------------------------------
  # ðŸ³ 4) Docker Build & Push to DockerHub
  # ----------------------------------------
  docker_push:
    needs: nexus_upload
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”‘ DockerHub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: ðŸ³ Build Docker Image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest .

      - name: ðŸ“¤ Push Docker Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest

  # ----------------------------------------
  # ðŸš€ 5) Deploy to EC2 via SSH
  # ----------------------------------------
  deploy:
    needs: docker_push
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Load SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: ðŸš€ Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          echo "--- Connected to EC2 ---"

          # Stop old container
          docker stop calculator || true
          docker rm calculator || true

          # Pull latest image
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest

          # Run container on Tomcat-style port 8080
          docker run -d --name calculator -p 8080:8080 \
            ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest

          echo "--- Deployment Completed ---"
          EOF
