name: ðŸš€ Java DevOps CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  # ------------------------------------------------------------
  # 1ï¸âƒ£ BUILD
  # ------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ› ï¸ Maven Clean Package (Skip UI Tests)
        run: mvn -B clean package -DskipTests=true

      - name: ðŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-jar
          path: target/*.jar

  # ------------------------------------------------------------
  # 2ï¸âƒ£ SONAR (must run AFTER build)
  # ------------------------------------------------------------
  sonar:
    name: ðŸ” SonarQube Analysis
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ”Ž SonarQube Scan (Maven plugin)
        run: |
          mvn -B verify sonar:sonar \
            -DskipTests=true \
            -Dsonar.projectKey=calculator \
            -Dsonar.projectName=CalculatorApp \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  # ------------------------------------------------------------
  # 3ï¸âƒ£ NEXUS UPLOAD (must run AFTER sonar)
  # ------------------------------------------------------------
  nexus:
    name: ðŸ“¤ Upload Artifact to Nexus (RAW)
    runs-on: ubuntu-latest
    needs: sonar
    steps:
      - name: ðŸ“¥ Download JAR Artifact
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar

      - name: ðŸ“¤ Upload to Nexus RAW Repository
        run: |
          FILE=$(ls *.jar)
          echo "Uploading: $FILE"
          curl -v -u "${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }}" \
            --upload-file "$FILE" \
            "${{ secrets.NEXUS_HOST }}/repository/java-raw/$FILE"

  # ------------------------------------------------------------
  # 4ï¸âƒ£ DOCKER BUILD & PUSH (must run AFTER nexus)
  # ------------------------------------------------------------
  docker:
    name: ðŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: nexus
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”½ Download JAR Artifact (for Docker context if needed)
        uses: actions/download-artifact@v4
        with:
          name: calculator-jar
          path: target/

      - name: ðŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: ðŸ› ï¸ Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USER }}/calculator:latest .

      - name: â˜ï¸ Push Docker Image
        run: docker push ${{ secrets.DOCKER_USER }}/calculator:latest

  # ------------------------------------------------------------
  # 5ï¸âƒ£ DEPLOY (must run AFTER docker)
  # ------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: ðŸ”‘ Setup SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: ðŸš€ SSH -> Deploy Container on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "Stopping old container..."
            sudo docker stop calculator || true
            sudo docker rm calculator || true

            echo "Pulling latest image..."
            sudo docker pull ${{ secrets.DOCKER_USER }}/calculator:latest

            echo "Running new container on port 5005..."
            sudo docker run -d --name calculator -p 5005:5005 ${{ secrets.DOCKER_USER }}/calculator:latest

            echo "Deployment complete!"
          EOF
