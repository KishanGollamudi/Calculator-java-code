name: Java CI-CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:

  build:
    name: üî® Build Stage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Maven Clean & Verify (creates target/)
        run: mvn -B clean verify


  sonar:
  runs-on: ubuntu-latest
  needs: build

  steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Run SonarQube Scan with Maven
      run: |
        mvn -B verify sonar:sonar \
          -Dsonar.projectKey=calculator \
          -Dsonar.projectName=CalculatorApp \
          -Dsonar.host.url=http://54.234.17.60:9000 \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}


  nexus_upload:
    name: üì¶ Upload Artifact to Nexus
    runs-on: ubuntu-latest
    needs: sonar

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Package JAR
        run: mvn -B package

      - name: Upload JAR to Nexus RAW Repo
        run: |
          curl -v -u "${{ secrets.NEXUS_USERNAME }}:${{ secrets.NEXUS_PASSWORD }}" \
          --upload-file target/*.jar \
          ${{ secrets.NEXUS_RAW_URL }}/calculator-latest.jar


  docker:
    name: üê≥ Docker Build & Push
    runs-on: ubuntu-latest
    needs: nexus_upload

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest .

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest


  deploy:
    name: üöÄ EC2 Deployment
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - name: SSH into EC2 & Deploy Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Stopping old container..."
            docker stop calculator || true
            docker rm calculator || true

            echo "Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest

            echo "Running new container on port 8080..."
            docker run -d --name calculator -p 8080:8080 ${{ secrets.DOCKERHUB_USERNAME }}/calculator:latest

            echo "Deployment completed successfully!"
